<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Nearby Hospitals</title>
</head>
<body>

<button onclick="getHospitals()">Find Nearby Hospitals</button>
<p id="status"></p>
<div id="list"></div>

<script>
function getHospitals() {
  document.getElementById("status").innerText = "Getting location...";

  navigator.geolocation.getCurrentPosition(loadHospitals, geoError);
}

async function loadHospitals(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;

  document.getElementById("status").innerText = "Fetching hospitals...";

  const query = `
    [out:json][timeout:25];
    (
      node["amenity"="hospital"](around:1500,${lat},${lon});
    );
    out tags;
  `;

  try {
    const response = await fetch(
      "https://overpass-api.de/api/interpreter",
      {
        method: "POST",
        body: query
      }
    );

    const text = await response.text();

    // SAFETY CHECK
    if (text.startsWith("<")) {
      throw new Error("Overpass returned HTML (server busy)");
    }

    const data = JSON.parse(text);
    showHospitals(data.elements);

  } catch (err) {
    document.getElementById("status").innerText =
      "Server busy. Please try again.";
    console.error(err);
  }
}

function showHospitals(hospitals) {
  const list = document.getElementById("list");
  list.innerHTML = "";

  document.getElementById("status").innerText =
    `Found ${hospitals.length} hospitals`;

  hospitals.forEach(h => {
    const div = document.createElement("div");
    div.innerHTML = `<b>${h.tags.name || "Unnamed Hospital"}</b>`;
    list.appendChild(div);
  });
}

function geoError() {
  document.getElementById("status").innerText =
    "Location permission denied";
}
</script>

</body>
</html>
